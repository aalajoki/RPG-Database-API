<!doctype html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
 
        <title>Rest API Authentication Example</title>
 
        <!-- CSS links will be here -->
 
    </head>
<body>
 
<!-- navbar -->
<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="#">Navbar</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav">
            <!-- <a class="nav-item nav-link" href="#" id='home'>Home</a> -->
            <a class="nav-item nav-link" href="#" id='create_character'>Create a character</a>
            <a class="nav-item nav-link" href="#" id='manage_characters'>Manage your characters</a>
            <a class="nav-item nav-link" href="#" id='manage_guilds'>Manage your guilds</a>
            <a class="nav-item nav-link" href="#" id='logout'>Logout</a>
            <a class="nav-item nav-link" href="#" id='login'>Login</a>
            <a class="nav-item nav-link" href="#" id='sign_up'>Sign Up</a>
        </div>
    </div>
</nav>
<!-- /navbar -->
 
<!-- container -->
<main role="main" class="container starter-template">
 
    <div class="row">
        <div class="col">
 
            <!-- where prompt / messages will appear -->
            <div id="response"></div>
 
            <!-- where main content will appear -->
            <div id="content"></div>
        </div>
    </div>
 
</main>
<!-- /container -->
 
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="style.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
// jQuery codes
$(document).ready(function()
{
    // show sign up / registration form
    $(document).on('click', '#sign_up', function(){
 
        var html = `
            <h2>Sign Up</h2>
            <form id='sign_up_form'>
                <div class="form-group">
                    <label for="first_name">Username</label>
                    <input type="text" class="form-control" name="username" id="username" required />
                </div>
 
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" class="form-control" name="email" id="email" required />
                </div>
 
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" class="form-control" name="password" id="password" required />
                </div>
 
                <button type='submit' class='btn btn-primary'>Sign Up</button>
            </form>
            `;
 
        clearResponse();
        $('#content').html(html);
    });
 
    // trigger when registration form is submitted
    $(document).on('submit', '#sign_up_form', function()
    {

        // get form data
        var sign_up_form=$(this);
        var form_data=JSON.stringify(sign_up_form.serializeObject());

        // submit form data to api
        $.ajax({
            url: "api/players/create_player.php",
            type : "POST",
            contentType : 'application/json',
            data : form_data,
            success : function(result) {
                // if response is a success, tell the user it was a successful sign up & empty the input boxes
                $('#response').html("<div class='alert alert-success'>" + xhr.responseJSON.body + "</div>");
                sign_up_form.find('input').val('');
            },
            error: function(xhr, resp, text){
                // Error message
                $('#response').html("<div class='alert alert-danger'>" + xhr.responseJSON.body + "</div>");
            }
        });

        return false;
    });
 
    // show login form
    $(document).on('click', '#login', function()
    {
        showLoginPage();
    });
 
    // trigger when login form is submitted
    $(document).on('submit', '#login_form', function()
    {

        // get form data
        var login_form=$(this);
        var form_data=JSON.stringify(login_form.serializeObject());

        // submit form data to api
        $.ajax({
            url: "api/players/login.php",
            type : "POST",
            contentType : 'application/json',
            data : form_data,
            success : function(result){

                // store jwt to cookie
                setCookie("jwt", result.jwt, 1);
                // show home page & tell the user it was a successful login
                //showHomePage();
                showManageCharacterForm();
                showLoggedInMenu();
                $('#response').html("<div class='alert alert-success'>" + xhr.responseJSON.body + "</div>");
            },
            error: function(xhr, resp, text){
                // on error, tell the user login has failed & empty the input boxes
                $('#response').html("<div class='alert alert-danger'>" + xhr.responseJSON.body + "</div>");
                console.log(xhr);
                login_form.find('input').val('');
            }
        });

        return false;
    });

    // show home page
    //$(document).on('click', '#home', function(){
    //    showHomePage();
    //    clearResponse();
    //});
 
    // show update account form
    $(document).on('click', '#create_character', function()
    {
        showCreateCharacterForm();
    });
    
    $(document).on('click', '#manage_characters', function()
    {
        showManageCharacterForm();
    });
    
    $(document).on('click', '#manage_guilds', function()
    {
        showManageGuildForm();
    });

    // Trigger when 'create character' form is submitted
    $(document).on('submit', '#create_character_form', function()
    {

        // handle for create_character_form
        var create_character_form = $(this);

        // validate jwt to verify access
        var jwt = getCookie('jwt');

        // get form data
        var create_character_form_obj = create_character_form.serializeObject()

        // add jwt on the object
        create_character_form_obj.jwt = jwt;

        // convert object to json string
        var form_data = JSON.stringify(create_character_form_obj);

        // submit form data to api
        $.ajax({
            url: "api/characters/create_character.php",
            type : "POST",
            contentType : "application/json",
            data : form_data,
            success : function(result) {
                $('#response').html("<div class='alert alert-danger'>" + xhr.responseJSON.body + "</div>");
            },
            error: function(xhr, resp, text){
                showLoginPage();
                $('#response').html("<div class='alert alert-danger'>" + xhr.responseJSON.body + "</div>");
            }
        });
        return false;
    });

    // logout the user
    $(document).on('click', '#logout', function()
    {
        showLoginPage();
        $('#response').html("<div class='alert alert-info'>You are logged out.</div>");
    });
 
    // remove any prompt messages
    function clearResponse()
    {
        $('#response').html('');
    }

    // show login page
    function showLoginPage()
    {

        // remove jwt
        setCookie("jwt", "", 1);

        // login page html
        var html = `
            <h2>Login</h2>
            <form id='login_form'>
                <div class='form-group'>
                    <label for='email'>Email address</label>
                    <input type='email' class='form-control' id='email' name='email' placeholder='Enter email'>
                </div>

                <div class='form-group'>
                    <label for='password'>Password</label>
                    <input type='password' class='form-control' id='password' name='password' placeholder='Password'>
                </div>

                <button type='submit' class='btn btn-primary'>Login</button>
            </form>
            `;

        $('#content').html(html);
        clearResponse();
        showLoggedOutMenu();
    }

    // Function to set cookie
    function setCookie(cname, cvalue, exdays)
    {
        var d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        var expires = "expires="+ d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    // If the user is logged out
    function showLoggedOutMenu()
    {
        // Show/hide navbar buttons
        $("#login, #sign_up").show();
        $("#logout, #create_character, #manage_characters").hide();
    }

    // Show home page
    //function showHomePage(){

        // Validate JWT
        //var jwt = getCookie('jwt');

        //$.post("api/players/validate_token.php", JSON.stringify({ jwt:jwt })).done(function(result) {
            // If valid, show homepage
            //var html = `
            //    <div class="card">
            //        <div class="card-header">Welcome to Home!</div>
            //        <div class="card-body">
            //            <h5 class="card-title">You are logged in.</h5>
            //            <p class="card-text">You won't be able to access the home and account pages if you are not logged in.</p>
            //        </div>
            //    </div>
            //    `;

            //$('#content').html(html);
            //showLoggedInMenu();
        //})
        // show login page on error
        //.fail(function(result){
        //    showLoginPage();
        //    $('#response').html("<div class='alert alert-danger'>Please login to access the home page.</div>");
        //});
    //}

    // get or read cookie
    function getCookie(cname)
    {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for(var i = 0; i <ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' '){
                c = c.substring(1);
            }

            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    // if the user is logged in
    function showLoggedInMenu()
    {
        // hide login and sign up from navbar & show logout button
        $("#login, #sign_up").hide();
        $("#logout, #create_character, #manage_characters").show();
    }

    function showCreateCharacterForm()
    {
        // validate jwt to verify access
        var jwt = getCookie('jwt');
        $.post("api/players/validate_token.php", JSON.stringify({ jwt:jwt })).done(function(result) {

            // if response is valid, put user details in the form
            var html = `
                    <h2>Create Character</h2>
                    <form id='create_character_form'>
                        <div class="form-group">
                            <label for="name">Character name</label>
                            <input type="text" class="form-control" name="name" id="name" required value="" />
                        </div>

                        <div class="form-group">
                            <label for="char_race">Character race</label>
                            <select name="char_race">
                                <option value="1">Human</option>
                                <option value="2">Dwarf</option>
                                <option value="3">Elf</option>
                            </select>
                        </div>
        
                        <div class="form-group">
                            <label for="char_class">Character class</label>
                            <select name="char_class">
                                <option value="1">Warrior</option>
                                <option value="2">Rogue</option>
                                <option value="3">Mage</option>
                            </select>
                        </div>

                        <button type='submit' class='btn btn-primary'>Create</button>
                    </form>
                `;

            clearResponse();
            $('#content').html(html);
        })
//<input type="email" class="form-control" name="email" id="email" required value="` + result.data.email + `" />
        // on error/fail, tell the user he needs to login to show the account page
        .fail(function(result){
            showLoginPage();
            $('#response').html("<div class='alert alert-danger'>" + xhr.responseJSON.body + "</div>");
        });
    }
    
    function showManageCharacterForm() 
    {
        // Get JWT for validation
        var jwt = getCookie('jwt');
        $('#content').empty();
        // If the user is logged in, search and show the user's characters
        $.post("api/players/validate_token.php", JSON.stringify({ jwt:jwt })).done(function(result) {
            $.post("api/characters/read_characters.php", JSON.stringify({ jwt:jwt })).done(function(result) {
                
                $('#content').append("<h1>Your characters</h1><table>");
                $('#content').append("<tr>");
                    $('#content').append("<td>ID</td>");
                    $('#content').append("<td>Name</td>");
                    $('#content').append("<td>Race</td>");
                    $('#content').append("<td>Class</td>");
                    $('#content').append("<td>Level</td>");
                    $('#content').append("<td>Guild</td>");
                    //$('#content').append("<td>Leave guild</td>");
                $('#content').append("</tr>");
                $(jQuery.parseJSON(JSON.stringify(result.data))).each(function() {
                    $('#content').append("<tr>");
                    $('#content').append("<td>" + this.id + "</td>");
                    $('#content').append("<td>" + this.name + "</td>");
                    $('#content').append("<td>" + this.race + "</td>");
                    $('#content').append("<td>" + this.class + "</td>");
                    $('#content').append("<td>" + this.level + "</td>");
                    $('#content').append("<td>" + this.guild + "</td>");
                    if (this.guild != null) {
                        $('#content').append("<td>Leave guild link here</td>");
                    }
                    //else {
                    //    $('#content').append("<td></td>");
                    //}
                    $('#content').append("</tr>");
               });
               $('#content').append("</table>");
                
                clearResponse();
            })
            .fail(function(result){
                showLoginPage();
                $('#response').html("<div class='alert alert-danger'>" + xhr.responseJSON.body + "</div>");
            });
        })
        .fail(function(result){
            showLoginPage();
            $('#response').html("<div class='alert alert-danger'>" + xhr.responseJSON.body + "</div>");
        });
    }
    
    function showManageGuildForm() 
    {
        // Get JWT for validation
        var jwt = getCookie('jwt');
        $('#content').empty();
        // If the user is logged in, search and show the user's guilds
        $.post("api/players/validate_token.php", JSON.stringify({ jwt:jwt })).done(function(result) {
            $.post("api/guilds/read_owned_guilds.php", JSON.stringify({ jwt:jwt })).done(function(result) {
                
                $('#content').append("<h1>Guilds you own</h1><table>");
                $('#content').append("<tr>");
                    $('#content').append("<td>ID</td>");
                    $('#content').append("<td>Name</td>");
                    $('#content').append("<td>Race</td>");
                    $('#content').append("<td>Class</td>");
                    $('#content').append("<td>Level</td>");
                    $('#content').append("<td>Guild</td>");
                    //$('#content').append("<td>Leave guild</td>");
                $('#content').append("</tr>");
                $(jQuery.parseJSON(JSON.stringify(result.data))).each(function() {
                    $('#content').append("<tr>");
                    $('#content').append("<td>" + this.id + "</td>");
                    $('#content').append("<td>" + this.name + "</td>");
                    $('#content').append("<td>" + this.race + "</td>");
                    $('#content').append("<td>" + this.class + "</td>");
                    $('#content').append("<td>" + this.level + "</td>");
                    $('#content').append("<td>" + this.guild + "</td>");
                    if (this.guild != null) {
                        $('#content').append("<td>Leave guild link here</td>");
                    }
                    //else {
                    //    $('#content').append("<td></td>");
                    //}
                    $('#content').append("</tr>");
               });
               $('#content').append("</table>");
                
                clearResponse();
            })
            .fail(function(result){
                showLoginPage();
                $('#response').html("<div class='alert alert-danger'>" + xhr.responseJSON.body + "</div>");
            });
        })
        .fail(function(result){
            showLoginPage();
            $('#response').html("<div class='alert alert-danger'>" + xhr.responseJSON.body + "</div>");
        });
    }
    
    //<input type="email" class="form-control" name="email" id="email" required value="` + result.data.email + `" />

    // Format form data into JSON
    $.fn.serializeObject = function(){

        var o = {};
        var a = this.serializeArray();
        $.each(a, function() {
            if (o[this.name] !== undefined) {
                if (!o[this.name].push) {
                    o[this.name] = [o[this.name]];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    };
    
    // Show login page when the page has loaded
    showLoginPage();
});
</script>


</body>
</html>